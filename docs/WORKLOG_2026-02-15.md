# WORKLOG 2026-02-15

## [TIME] 15:06 (KST) — [PLAN] Validation 커스텀 메시지 우선순위 회귀 수정

### 실행 계획
# 🧠 실행 계획 보고

## 0. 이동할 브랜치
- 현재 브랜치 유지: `fix/validation-error-message-format`

## 1. 작업 목표
- 애노테이션에 명시된 커스텀 메시지(`@NotBlank(message="...")`)를 우선적으로 반환
- 프레임워크 기본 메시지일 때만 제약코드 기반 커스텀 메시지로 대체

## 2. 현재 상태 분석
- 관련 파일
  - `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
- 현재 로직 요약
  - `isKnownConstraintCode(fieldError)`가 true면 무조건 `getFieldSpecificValidationMessage` 사용
  - 이로 인해 `jobName` 같은 커스텀 메시지가 일반 메시지로 덮임
- 문제 원인
  - `defaultMessage` 우선순위가 제약코드 분기보다 뒤에 배치됨

## 3. 변경 예정 파일 목록
- `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
- `docs/WORKLOG_2026-02-15.md`
- `docs/CHANGELOG_2026-02-15.md`

## 4. 변경 전략
- 1차: `resolveValidationMessage` 우선순위를 다음 순서로 재정렬
  - (a) `defaultMessage` 존재 시 우선 반환
  - (b) 단, 기본 메시지 템플릿으로 판단되는 경우만 제약코드 기반 커스텀 생성
  - (c) 기본/커스텀 모두 없으면 field fallback
- 2차: 기본 메시지 판별은 문자열 하드코딩이 아닌 `fieldError.getCodes()` + `defaultMessage` 패턴 최소 검증으로 안전 분기
- 3차: `./gradlew` 실행으로 컴파일 검증 (`./gradlew test` 제외)

## 5. 예상 영향 범위
- 영향 있음: validation 에러 메시지 선택 우선순위
- 영향 없음: HTTP 상태코드/에러코드/비즈니스 로직

## 6. 리스크 분석
- 실패 가능성
  - 기본 메시지 판별 기준이 과하거나 부족하면 일부 케이스 메시지 품질 저하 가능
- 완화
  - 커스텀 메시지 우선 원칙을 확실히 보장하고, 나머지는 현재 fallback 유지
- 롤백 방법
  - `GlobalExceptionHandler` 해당 메서드 원복

## 7. 테스트 계획
- `./gradlew`
- 수동 확인: `ScheduleReqDto.jobName` 공백 요청 시 "Job Name은 필수입니다" 유지 확인

### 승인 여부
- 승인 완료 (사용자 응답: "진행하자")
- 승인 시간: 15:07

## [TIME] 15:07 (KST) — [START] Validation 커스텀 메시지 우선순위 회귀 수정 구현 시작

## [TIME] 15:08 (KST) — [IMPLEMENT] Validation 커스텀 메시지 우선순위 보장 로직 수정

### 수행 내용
- 파일: `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
- 변경
  - `resolveValidationMessage` 우선순위 재정렬
  - 기존: `isKnownConstraintCode` true면 즉시 일반화 메시지 생성
  - 변경: `defaultMessage`가 존재하면 무조건 우선 반환
  - `defaultMessage`가 비어 있을 때만 `getFieldSpecificValidationMessage` 경로로 진입
- 효과
  - `@NotBlank(message = "Job Name은 필수입니다")` 같은 명시 커스텀 메시지가 더 이상 일반 메시지로 덮어써지지 않음

### VERIFY
- 루트에서 `./gradlew` 실행
  - 결과: 성공 (`BUILD SUCCESSFUL`)
- 사용자 요청에 따라 `./gradlew test`는 실행하지 않음

# 📊 계획 대비 수행 결과 비교

## 계획 대비 차이
- 계획과 동일하게 단일 메서드 우선순위 수정으로 완료

## 추가 발생 이슈
- 없음

## 계획 외 수정 사항
- 없음

## [TIME] 15:20 (KST) — [PLAN] Validation 메시지 우선순위 재설계 + AGENTS 더블체크 규칙 추가

### 실행 계획
# 🧠 실행 계획 보고

## 0. 이동할 브랜치
- 현재 브랜치 유지: `fix/validation-error-message-format`

## 1. 작업 목표
- `resolveValidationMessage`를 재설계해 필드 특화/커스텀 메시지/기본 메시지 변환 우선순위를 명확화
- 같은 유형의 회귀를 방지하기 위해 AGENTS.md에 "수정 전/후 역검증 더블체크" 규칙 명시

## 2. 현재 상태 분석
- 관련 파일
  - `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
  - `AGENTS.md`
- 현재 로직 요약
  - `defaultMessage` 우선으로 인해 `FIELD_SPECIFIC_MESSAGES`가 무시될 수 있음
  - `@Min` 기본 메시지(영문)가 그대로 노출될 수 있음
- 문제 원인
  - 메시지 분기 우선순위 정의가 목표(정교화)와 불일치
  - 변경 시 회귀 체크리스트가 문서 규칙에 없어 검증 누락 가능

## 3. 변경 예정 파일 목록
- `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
- `AGENTS.md`
- `docs/WORKLOG_2026-02-15.md`
- `docs/CHANGELOG_2026-02-15.md`

## 4. 변경 전략
- 1차: `resolveValidationMessage` 우선순위를 다음으로 고정
  - (a) 필드 특화 메시지(`FIELD_SPECIFIC_MESSAGES`) 우선
  - (b) `defaultMessage`가 있고, 프레임워크 기본 메시지가 아닌 경우 그대로 반환
  - (c) 기본 메시지 또는 메시지 미존재 시 제약코드 기반 커스텀 생성
  - (d) 최종 fallback
- 2차: 기본 메시지 판별은 문자열 하드코딩을 최소화하고, 제약코드(`getCodes`)와 조합해 보수적으로 처리
- 3차: `AGENTS.md`에 "더블체크 규칙" 추가
  - 변경 직후 필수 역검증 항목(커스텀 유지/기본 메시지 변환/필드 특화 적용/fallback)을 명시
- 4차: `./gradlew`로 검증 (`./gradlew test` 제외)

## 5. 예상 영향 범위
- 영향 있음: Validation 에러 메시지 선택 로직, 작업 품질 규칙
- 영향 없음: 비즈니스 로직/DB/API 스펙/인증 플로우

## 6. 리스크 분석
- 실패 가능성
  - 메시지 우선순위 변경으로 일부 기존 응답 문구가 달라질 수 있음
- 완화
  - 우선순위를 코드로 명시하고 필수 체크리스트로 회귀 점검
- 롤백 방법
  - `GlobalExceptionHandler`, `AGENTS.md` 변경분 파일 단위 원복

## 7. 테스트 계획
- `./gradlew`
- 수동 역검증
  - `@NotBlank(message=...)` 커스텀 메시지 유지
  - `@Min/@Max` 기본 메시지 대신 서비스 문구 반환
  - `balance/amount/dayOfWeek/dayOfMonth` 필드 특화 메시지 적용

### 승인 여부
- 승인 완료 (사용자 응답: "진행해")
- 승인 시간: 15:23

## [TIME] 15:23 (KST) — [START] Validation 우선순위 재설계 + AGENTS 더블체크 규칙 적용 시작

## [TIME] 15:24 (KST) — [IMPLEMENT] Validation 메시지 우선순위 재설계 + AGENTS 더블체크 규칙 추가

### 수행 내용
- `src/main/java/com/moneylog_backend/global/exception/GlobalExceptionHandler.java`
  - `resolveValidationMessage` 우선순위 재설계
    1) 애노테이션에 명시된 커스텀 메시지면 최우선 반환 (`hasExplicitCustomMessage`)
    2) 필드 특화 메시지(`FIELD_SPECIFIC_MESSAGES`) 적용
    3) 알려진 제약코드면 제약별 커스텀 메시지 생성
    4) 그 외 `defaultMessage` 또는 field fallback
  - 문자열 하드코딩 기반 기본 메시지 판별 대신, 제약코드 + 리플렉션으로 명시 커스텀 여부 판별
  - `CONSTRAINT_ANNOTATIONS`, `extractConstraintCode`, `hasExplicitCustomMessage` 등 보조 메서드 추가
- `AGENTS.md`
  - `### C-1. 더블체크 (필수)` 섹션 신설
  - 최종 보고 전 회귀 방지 역검증 4항목을 WORKLOG `[DOUBLE-CHECK]`로 의무 기록하도록 규칙 추가

### VERIFY
- 루트에서 `./gradlew` 실행
  - 결과: 성공 (`BUILD SUCCESSFUL`)
- 사용자 요청에 따라 `./gradlew test`는 실행하지 않음

### [DOUBLE-CHECK]
- 핵심 시나리오 개선 확인
  - 커스텀 메시지(`@NotBlank(message="...")`)가 일반 메시지로 덮이지 않도록 우선순위 수정 완료
- 기존 정상 동작 회귀 점검
  - `balance/amount/dayOfWeek/dayOfMonth` 필드 특화 메시지 분기 유지 확인
- 우선순위 변경 역검증
  - 커스텀 메시지 우선 -> 필드특화 -> 제약코드 -> fallback 순서로 코드 고정
- 재발 조건 점검
  - 리뷰 지적사항(커스텀 덮어쓰기, 기본 영문 노출) 재발 가능 분기 제거 확인

# 📊 계획 대비 수행 결과 비교

## 계획 대비 차이
- 계획대로 `GlobalExceptionHandler`와 `AGENTS.md` 2개 파일만 수정

## 추가 발생 이슈
- 없음

## 계획 외 수정 사항
- 없음
