# WORKLOG_2026-02-26

## [PLAN]
- PLAN 문서: `docs/2026-02-26/PLAN_2026-02-26.md`
- 작업 목표: 로컬/AWS 파일 업로드 이중 프로필 구현 및 공용 업로드 API 확장

## [APPROVED]
- 승인 완료 문구: 사용자 요청 `Implement the plan.` 확인
- 승인 시간: 20:26 (KST)

## [START]
- 시작 시간: 20:26 (KST)
- 시작 목표: 업로드 저장소 추상화 + 설정 분리 + API 연동 구현

## [IMPLEMENT]
- 20:27
- `src/main/java/com/moneylog_backend/global/file/FileStore.java` 제거
- 기존 로컬 고정 구현을 대체하기 위해 저장소 추상화 구조로 전환 시작

- 20:28
- 신규 추가:
  - `global/file/FileStorage.java`
  - `global/file/FileStorageType.java`
  - `global/file/FileProperties.java`
  - `global/file/FileDownloadResult.java`
  - `global/file/FileUploadResult.java`
  - `global/file/LocalFileStorage.java`
  - `global/file/S3FileStorage.java`
  - `global/file/FileStorageService.java`
  - `global/file/AwsS3Config.java`
- 변경 의도:
  - local/s3 저장소 분리
  - fileRef 기반 라우팅(`/uploads/...`, `s3://...`) 처리
  - 파일 크기/확장자 검증 중앙화

- 20:29
- 수정:
  - `moneylog/file/FileController.java`
  - `moneylog/user/service/UserService.java`
- 변경 내용:
  - `/api/files/upload` 추가
  - 다운로드 시 s3는 redirect, local은 기존 stream 응답 유지
  - 회원가입 업로드를 `FileStorageService`로 교체

- 20:30
- 수정:
  - `src/main/resources/application.yml`
  - `src/main/resources/application-local.yml`
  - `build.gradle`
  - `global/constant/ErrorMessageConstants.java`
- 변경 내용:
  - AWS 기본 파일 저장 설정(`app.file.storage.type=s3`) 추가
  - local 프로필 override 설정 추가
  - AWS SDK S3 의존성 추가
  - 파일 관련 에러 상수 추가

## [VERIFY]
- 20:30
- 실행: `./gradlew test`
- 결과: 실패
- 핵심 에러: MySQL 연결 실패로 `contextLoads()` 실패
  - `Communications link failure`
  - `Unable to determine Dialect without JDBC metadata`
- 분석: 테스트 환경 DB 미기동/미연결로 인한 기존 환경 이슈로 판단

- 20:31
- 실행: `./gradlew compileJava`
- 결과: 성공

## [DOUBLE-CHECK]
- 해결 목표 시나리오 개선 여부:
  - local/s3 저장소 분기 가능 구조로 개선됨
  - AWS 기본 + local override 설정 분리 완료
- 회귀 여부:
  - 기존 `/uploads/...` 경로 처리 로직 유지(legacy 지원)
  - 회원가입 업로드 흐름은 서비스 인터페이스로 치환
- 반대 케이스 점검:
  - 잘못된 업로드 경로/확장자/용량은 `IllegalArgumentException`으로 차단
  - s3 비활성 상태에서 `s3://` 접근 시 명시적 오류 처리

## [계획 대비 차이]
- 계획에서는 라우팅 규칙을 명시했으며 구현에서도 동일 규칙 적용
- 다만 API 응답 포맷은 신규 DTO(record)로 구체화해 명확히 고정함

## [추가 발생 이슈]
- 통합 테스트는 DB 미연결로 실패하여 전체 green 상태 확인은 불가

## [계획 외 수정 사항]
- 없음

## [APPROVED-2]
- 승인 완료 문구: 사용자 요청 `진행해. 그리고 회원의 이미지 url을 기반으로 이미지도 출력되도록 해줘`
- 승인 시간: 20:43 (KST)

## [START-2]
- 시작 시간: 20:43 (KST)
- 시작 목표: 프로필 이미지 DB 업데이트 API + 이미지 출력(view) + 프론트 아바타 반영

## [IMPLEMENT-2]
- 20:44
- 수정:
  - `moneylog/user/entity/UserEntity.java`
  - `moneylog/user/service/UserService.java`
  - `moneylog/user/controller/UserController.java`
  - `global/constant/ErrorMessageConstants.java`
- 변경 내용:
  - `updateProfileImageUrl` 엔티티 메서드 추가
  - `updateProfileImage` 서비스 메서드 추가(업로드 + DB 갱신 + 기존 파일 삭제 시도)
  - `PUT /api/user/profile-image` endpoint 추가
  - 파일 필수 에러 메시지 추가

- 20:45
- 수정:
  - `moneylog/file/FileController.java`
  - `global/config/SecurityConfig.java`
- 변경 내용:
  - `GET /api/files/view` endpoint 추가 (local: inline resource, s3: presigned redirect)
  - 프론트 `<img src>` 로딩을 위해 `/api/files/view` `permitAll` 허용

- 20:46
- 수정:
  - `src/moneylog/src/types/finance.ts`
  - `src/moneylog/src/api/axiosConfig.js`
  - `src/moneylog/src/api/queries.ts`
  - `src/moneylog/src/utils/profileImage.ts` (신규)
  - `src/moneylog/src/Pages/FinancePage.tsx`
  - `src/moneylog/src/styles/pages/FinancePage.css`
- 변경 내용:
  - `UserInfo` 타입에 `id`, `profileImageUrl` 필드 반영
  - 프로필 이미지 업데이트 mutation(`useUpdateProfileImage`) 추가
  - FinancePage 헤더/드롭다운 아바타 출력 반영
  - 프로필 이미지 변경 메뉴 + 숨김 파일 input + 업로드 처리 추가

## [VERIFY-2]
- 실행: `./gradlew compileJava`
- 결과: 성공

- 실행: `cd src/moneylog && npm run build`
- 결과: 실패
- 실패 원인: `vite` 실행 스크립트 CRLF 이슈로 shell 인식 실패 (`sh: 1: vite: not found`)

- 실행: `cd src/moneylog && node node_modules/vite/bin/vite.js build` (대체 시도)
- 결과: 실패
- 실패 원인: optional dependency 누락 (`Cannot find module @rollup/rollup-linux-x64-gnu`)

## [DOUBLE-CHECK-2]
- 확인 항목:
  - 기존 회원가입 업로드 및 user/info 회귀 여부
  - `/api/files/download` 동작 영향 여부
  - `permitAll` 추가 경로(`/api/files/view`) 외 보안 규칙 영향 여부

## [계획 대비 차이-2]
- 이미지 변경 UI까지 포함해 FinancePage에서 즉시 사용 가능 상태로 확장 구현

## [추가 발생 이슈-2]
- 없음

## [계획 외 수정 사항-2]
- 없음
